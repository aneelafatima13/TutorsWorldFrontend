
@{
    ViewBag.Title = "LoginUserScreen";
    Layout = "~/Views/Shared/_MainLayout.cshtml";

    var userCookie = Request.Cookies["UserProfile"];

    // Redirect to login if cookie is missing
    if (userCookie == null)
    {
        Response.Redirect(Url.Action("Login", "Home"));
        return;
    }

    string role = userCookie["Role"];
    long currentId = 0;

    // Determine the specific Profile ID based on the Role
    // 0 = Tutor, 1 = Student, 2 = Guardian
    if (role == "Tutor")
    {
        long.TryParse(userCookie["TutorId"], out currentId);
    }
    else if (role == "Student")
    {
        long.TryParse(userCookie["StudentId"], out currentId);
    }
    else if (role == "Gardian")
    {
        long.TryParse(userCookie["GardianId"], out currentId);
    }
}

<input type="hidden" id="hdnUserId" value="@currentId" />
<input type="hidden" id="hdnUserRole" value="@role" />
<input type="hidden" id="hdnCurrentConnectionId"/>

<style>
   /* --- Navigation Styles --- */
.tab-nav {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
    border-bottom: 1px solid #e2e8f0;
    gap: 2rem;
}

.tab-item { position: relative; }

.tab-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 4px;
    text-decoration: none !important;
    color: #718096;
    font-weight: 500;
    font-size: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.tab-link:hover { color: #2d3748; }

.tab-link.active {
    color: #007bff;
    font-weight: 600;
}

.tab-link.active::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 3px;
    background-color: #007bff;
    border-radius: 10px 10px 0 0;
    animation: slideIn 0.3s ease-out;
}

/* --- Content Pane Styles --- */
.custom-tab-pane {
    display: none; /* Hidden by default */
    animation: fadeIn 0.4s ease;
}

.custom-tab-pane.active {
    display: block; /* Shown when active */
}

/* --- Animations --- */
@@keyframes slideIn {
    from { transform: scaleX(0); opacity: 0; }
    to { transform: scaleX(1); opacity: 1; }
}

@@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}


    /* Tab Content Box */
    #userDashboardContent {
        border-radius: 12px !important;
        border: 1px solid #eaeaea !important;
        margin-top: -1px; /* Seamless connection if needed */
    }

    /* Icon Support (Optional but recommended) */
    .custom-tabs .nav-link i {
        margin-right: 8px;
        font-size: 1.1rem;
    }

    /* Selected connection styling */
    .connection-item {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }

        .connection-item:hover {
            background-color: #f8f9fa;
        }

    .selected-connection {
        border: 2px solid #28a745 !important; /* Green Border */
        border-left: 5px solid #28a745 !important;
        background-color: #f0fff4;
    }
    .profile-card {
        padding: 20px;
        background: #fff;
        transition: transform 0.2s;
    }

    .tutor-view {
        border-top: 4px solid #007bff; /* Blue for Tutors */
    }

    .student-view {
        border-top: 4px solid #28a745; /* Green for Students */
    }

    .profile-card h5 {
        color: #444;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 1px;
    }
</style>
<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-3">
                <div class="shop__sidebar shadow-sm border rounded p-3 bg-white">
                    <div class="sidebar__item">
                        <h4 id="connectionTitle">My Connections</h4>
                        <ul id="connectionList" class="list-group list-group-flush mt-3">
                            <li class="list-group-item text-muted">Loading...</li>
                        </ul>
                    </div>
                </div>


            </div>

            <div class="col-lg-9 col-md-9" id="tabs">
                <ul class="tab-nav" id="userDashboardTabs">
                    <li class="tab-item">
                        <a class="tab-link active" data-target="#profile" href="javascript:void(0)">
                            <i class="fa fa-user-circle"></i>
                            <span>Profile</span>
                        </a>
                    </li>
                    <li class="tab-item">
                        <a class="tab-link" data-target="#timetable" href="javascript:void(0)">
                            <i class="fa fa-calendar"></i>
                            <span>TimeTable</span>
                        </a>
                    </li>
                    <li class="tab-item">
                        <a class="tab-link" data-target="#assignments" href="javascript:void(0)">
                            <i class="fa fa-tasks"></i>
                            <span>Assignments</span>
                        </a>
                    </li>
                    <li class="tab-item">
                        <a class="tab-link" data-target="#leaves" href="javascript:void(0)">
                            <i class="fa fa-envelope-open"></i>
                            <span>Leaves</span>
                        </a>
                    </li>
                </ul>

                <div class="tab-content-wrapper">
                    <div class="custom-tab-pane active" id="profile">
                        <div id="profile-data-container">
                            <div class="text-center py-5">
                                <div class="spinner-border text-success" role="status"></div>
                                <p class="mt-2">Selecting Connection...</p>
                            </div>
                        </div>
                    </div>

                    <div class="custom-tab-pane" id="timetable">
                        <h4>Weekly Schedule</h4>
                        <p>Your class schedule will appear here.</p>
                    </div>

                    <div class="custom-tab-pane" id="assignments">
                        <h4>Assignments</h4>
                        <p>No pending assignments found.</p>
                    </div>

                    <div class="custom-tab-pane" id="leaves">
                        <h4>Leave Requests</h4>
                        <p>History of your leave applications.</p>
                    </div>
                </div>
            </div>
       

        </div>
    </div>
</section>

@section scripts{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

   <script>
       $(document).ready(function () {
           $('.tab-link').on('click', function (e) {
               e.preventDefault();

               // 1. Get the target ID from data-target
               const target = $(this).data('target');

               // 2. Update Active Class on Nav Links
               $('.tab-link').removeClass('active');
               $(this).addClass('active');

               // 3. Update Active Class on Content Panes
               $('.custom-tab-pane').removeClass('active');
               $(target).addClass('active');

               // Optional: Re-fetch data if profile tab is clicked and empty
               if (target === "#profile" && $('#profile-data-container').is(':empty')) {
                   // You can call your fetchConnectionProfile(id) here if needed
               }
           });
       });
       $(document).ready(function () {
           loadSidebarConnections();
       });

       function loadSidebarConnections() {
           var role = $("#hdnUserRole").val();
           $("#connectionTitle").text(role === "Tutor" ? "My Students" : "My Tutors");
           var connectionrole = role === "Tutor" ? "Student" : "Tutor"
           $.ajax({
               url: '/LoginUser/GetConnectionsProxy',
               type: 'GET',
               dataType: 'json',
               success: function (response) {
                   var html = "";
                   if (response.success && response.data && response.data.length > 0) {
                       $.each(response.data, function (i, item) {
                           // We store ConnectionId and the Name in data attributes
                           html += `
                    <li class="list-group-item connection-item d-flex justify-content-between align-items-center shadow-sm mb-2 rounded" 
                        data-id="${item.ConnectionId}" 
                        data-type="${connectionrole}" 
                        onclick="selectConnection(this)">
                        <span>
                            <i class="fa fa-user-circle mr-2 text-primary"></i>
                            <strong>${item.ConnectionName}</strong>
                        </span>
                    </li>`;
                       });

                       $("#connectionList").html(html);

                       // AUTO-SELECT the first connection
                       var firstItem = $('#connectionList li:first');
                       selectConnection(firstItem);

                   } else {
                       $("#connectionList").html('<li class="list-group-item text-muted text-center">No connections found.</li>');
                       $("#profile-data-container").html('<p class="p-3">No profile to display.</p>');
                   }
               },
               error: function () {
                   $("#connectionList").html('<li class="list-group-item text-danger">Error loading data.</li>');
               }
           });
       }

       function selectConnection(element) {
           // 1. Visual Update: Remove green border from others, add to this one
           $(".connection-item").removeClass("selected-connection");
           $(element).addClass("selected-connection");

           // 2. Set the Hidden Field
           var connectionId = $(element).attr("data-id");
           $("#hdnCurrentConnectionId").val(connectionId);

           // 3. Fetch the Profile Details
           fetchConnectionProfile(connectionId);
       }

       function fetchConnectionProfile(id) {
           // Show Loading Spinner
           $("#profile-data-container").html(`
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-2">Loading Profile...</p>
        </div>`);

           // Determine target role (If I am a Tutor, I am fetching a Student's profile)
           var myRole = $("#hdnUserRole").val();
           var targetRole = (myRole === "Tutor") ? "Student" : "Tutor";
           if (targetRole === "Tutor") {
               
               $("#profile-data-container").html(getTutorTemplate());

               
           } else {
               // Handle Student similarly
               $("#profile-data-container").html(getStudentTemplate());
           }
           // Call your Proxy (adjusting the URL to pass the selected ID and target Role)
           $.ajax({
               url: '/LoginUser/GetProfileDataProxybyId', // We'll create this simplified proxy next
               type: 'GET',
               data: { id: id, role: targetRole },
               success: function (response) {
                   debugger;
                   if (response.success && response.data) {
                       // Pass response.data (the actual profile) instead of the whole object
                       renderProfile(response.data, targetRole);
                   } else {
                       $("#profile-data-container").html('<p class="text-warning">No profile data found.</p>');
                   }
               },
               error: function () {
                   $("#profile-data-container").html('<p class="text-danger">Failed to load profile details.</p>');
               }
           });
       }

       function renderProfile(data, targetRole) {
           debugger;
           if (targetRole === "Tutor") {
               // 1. Inject the structure
               populateTutorData(data); // A 50ms delay is usually enough to let the browser register the new IDs

           } else {
               populateStudentData(data)
           }
       }
       // Function to just return the empty HTML shell
       function getTutorTemplate() {
           return `
    <div class="profile-card tutor-view">
        <div class="row bg-white shadow-sm rounded p-4">
            <div class="col-md-12">
                <div class="d-flex align-items-center mb-4">
                    <img id="tutor-img" src="/Content/img/default-user.png" class="rounded-circle img-thumbnail" style="width: 120px; height: 120px; object-fit: cover;" />
                    <div class="ml-4">
                        <h3 id="tutor-name" class="font-weight-bold mb-0">---</h3>
                        <p id="tutor-city" class="text-muted"><i class="fa fa-map-marker"></i> ---</p>
                        <div id="classes-container"></div>
                    </div>
                </div>
                <hr />
                <h5 class="font-weight-bold text-primary"><i class="fa fa-user"></i> Personal Information</h5>
                <div class="row mt-3">
                    <div class="col-6"><strong>Email:</strong> <p id="tutor-email">---</p></div>
                    <div class="col-6"><strong>Phone:</strong> <p id="tutor-phone">---</p></div>
                    <div class="col-6"><strong>Gender:</strong> <p id="tutor-gender">---</p></div>
                    <div class="col-6"><strong>Teaching:</strong> <p id="tutor-source">---</p></div>
                </div>
                <hr />
                <h5 class="font-weight-bold text-primary"><i class="fa fa-graduation-cap"></i> Qualifications</h5>
                <div id="qualifications-list" class="mt-2"></div>
                <hr />
                <h5 class="font-weight-bold text-primary"><i class="fa fa-briefcase"></i> Experience</h5>
                <div id="experience-list" class="mt-2"></div>
            </div>
            <div class="col-md-12 mt-4">
                <h5 class="font-weight-bold mb-3">Professional Resume</h5>
                <div class="resume-viewer border rounded bg-dark" style="height: 600px; overflow: hidden;">
                    <iframe id="resume-frame" src="" width="100%" height="100%" style="border:none; display:none;"></iframe>
                    <div id="no-resume" class="text-white text-center p-5">
                        <i class="fa fa-file-pdf-o fa-3x mb-3"></i>
                        <p>No Resume provided.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
       }
       function getStudentTemplate() {
           return `
<div class="profile-card student-view">
    <div class="row bg-white shadow-sm rounded p-4">
        <div class="col-md-12">
            <div class="d-flex align-items-center mb-4">
                <img id="stu-img" src="/Content/img/default-student.png" class="rounded-circle img-thumbnail" style="width: 120px; height: 120px; object-fit: cover;" />
                <div class="ml-4">
                    <h3 id="stu-name" class="font-weight-bold mb-0">---</h3>
                    <p class="text-muted"><i class="fa fa-id-card"></i> Roll No: <span id="stu-roll">---</span></p>
                </div>
            </div>
            <hr />
            
            <h5 class="font-weight-bold text-primary"><i class="fa fa-user"></i> Student Information</h5>
            <div class="row mt-3">
                <div class="col-md-6"><strong>Email:</strong> <p id="stu-email">---</p></div>
                <div class="col-md-6"><strong>Contact:</strong> <p id="stu-phone">---</p></div>
                <div class="col-md-6"><strong>Gender:</strong> <p id="stu-gender">---</p></div>
                <div class="col-md-6"><strong>B-Form / CNIC:</strong> <p id="stu-bform">---</p></div>
            </div>
            <hr />

            <h5 class="font-weight-bold text-primary"><i class="fa fa-book"></i> Academic Details</h5>
            <div class="row mt-3">
                <div class="col-md-12"><strong>Target Subjects:</strong> <p id="stu-subjects">---</p></div>
            </div>
            <hr />

            <h5 class="font-weight-bold text-success"><i class="fa fa-shield"></i> Guardian Information</h5>
            <div class="row mt-3">
                <div class="col-md-6"><strong>Guardian Name:</strong> <p id="guard-name">---</p></div>
                <div class="col-md-6"><strong>Relationship:</strong> <p id="guard-rel">---</p></div>
                <div class="col-md-6"><strong>Guardian Contact:</strong> <p id="guard-phone">---</p></div>
                <div class="col-md-6"><strong>Guardian CNIC:</strong> <p id="guard-cnic">---</p></div>
            </div>
        </div>
    </div>
</div>`;
       }
       // Function to fill the shell with data
       function populateTutorData(data) {
           if (!data) return;
           console.log("tutor data", data);
           // Basic Info
           $('#tutor-name').text(data.fullName || "N/A");
           $('#tutor-city').html(`<i class="fa fa-map-marker"></i> ${data.city || 'N/A'}`);
           $('#tutor-email').text(data.contactEmail || "N/A");
           $('#tutor-phone').text(data.contactNo || "N/A");
           $('#tutor-gender').text(data.gender || "N/A");
           $('#tutor-source').text(data.teachingSource || "N/A");

           // Profile Image
           if (data.profileImgBytes && data.profileImgBytes.length > 50) {
               $('#tutor-img').attr('src', 'data:image/png;base64,' + data.profileImgBytes);
           }

           // Classes
           let classHtml = (data.classes || []).map(c =>
               `<span class="badge badge-primary mr-1 p-2">${c.className}</span>`
           ).join('');
           $('#classes-container').html(classHtml || 'No classes listed');

           // Qualifications
           let qualHtml = (data.qualifications || []).map(q => `
        <div class="mb-3 p-2 border-left border-primary">
            <h6 class="mb-0 font-weight-bold">${q.degree}</h6>
            <p class="mb-0 text-muted small">${q.institute} | Year: ${q.passingYear}</p>
            <p class="mb-0 small text-success">Percentage: ${q.percentage}%</p>
        </div>`).join('');
           $('#qualifications-list').html(qualHtml || 'No qualifications listed');

           // Experience
           let expHtml = (data.experiences || []).map(e => `
        <div class="mb-3 p-2 border-left border-success">
            <h6 class="mb-0 font-weight-bold">${e.expInstitute || 'Private Tutoring'}</h6>
            <p class="mb-0 text-muted small">Duration: ${e.expDuration || '0'} Months</p>
        </div>`).join('');
           $('#experience-list').html(expHtml || 'No experience listed');

           // Resume Logic (Note: your JSON shows "resumePdf: null", check "resumeBytes")
           if (data.resumeBytes && data.resumeBytes.length > 50) {
               const blob = b64toBlob(data.resumeBytes, 'application/pdf');
               $('#resume-frame').attr('src', URL.createObjectURL(blob)).show();
               $('#no-resume').hide();
           }
       }
           // Keep your b64toBlob utility function as it was...
           function b64toBlob(b64Data, contentType) {
               const byteCharacters = atob(b64Data);
               const byteArrays = [];
               for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                   const slice = byteCharacters.slice(offset, offset + 512);
                   const byteNumbers = new Array(slice.length);
                   for (let i = 0; i < slice.length; i++) {
                       byteNumbers[i] = slice.charCodeAt(i);
                   }
                   const byteArray = new Uint8Array(byteNumbers);
                   byteArrays.push(byteArray);
               }
               return new Blob(byteArrays, { type: contentType });
           }
       function populateStudentData(data) {
           if (!data || !data.student) return;

           const stu = data.student;
           const guard = data.gardian || {}; // Matches your C# 'Gardian' property name
           debugger;
           // Bind Student Basic Info
           $('#stu-name').text(stu.fullName || "N/A");
           $('#stu-roll').text(stu.rollNo || "N/A");
           $('#stu-email').text(stu.email || "N/A");
           $('#stu-phone').text(stu.contactNo || "N/A");
           $('#stu-gender').text(stu.studentGender || "N/A");
           $('#stu-bform').text(stu.bFormNo || "N/A");
           $('#stu-subjects').text(stu.targetSubjects || "N/A");

           // Bind Guardian Info
           $('#guard-name').text(guard.gardianName || "N/A");
           $('#guard-rel').text(guard.relationship || "N/A");
           $('#guard-phone').text(guard.contactNo || "N/A");
           $('#guard-cnic').text(guard.cnic || "N/A");

           // Profile Image Logic (using the bytes you read in the repository)
           if (stu.profileImgBytes && stu.profileImgBytes.length > 0) {
               $('#stu-img').attr('src', 'data:image/png;base64,' + stu.profileImgBytes);
           } else {
               $('#stu-img').attr('src', '/Content/img/default-student.png');
           }
       }
    </script>
}
